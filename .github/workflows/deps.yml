name: Update Dependencies
on:
  schedule:
    - cron: 0 0 * * 1
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-conda:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Generate conda package lock
        run: >
          bazel run
          --show_progress_rate_limit=5
          //:generate_package_lock
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        id: make_pr
        with:
          commit-message: >
            build(deps): update conda dependencies
          title: >
            build(deps): update conda dependencies
          author: GitHub Action <10xbuild@users.noreply.github.com>
          # Note: using `GITHUB_TOKEN` here means that the PR won't
          # trigger any workflows.
          token: ${{secrets.GITHUB_TOKEN}}
          body: |
            Auto-generated by generate_package_lock.
          branch: dependabot/conda/update-conda-dependencies/${{ github.ref_name }}
          delete-branch: true
          labels: |
            dependencies
      - name: Enable auto-merge
        run: gh pr merge --auto --squash "$PR_URL"
        if: ${{
          steps.make_pr.outputs.pull-request-url &&
          steps.make_pr.outputs.pull-request-operation == 'created' }}
        env:
          PR_URL: ${{steps.make_pr.outputs.pull-request-url}}
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
